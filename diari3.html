<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguiment Alumnes CFA La Pau</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4C/uK8iV5m8+gP8xJz5jT5s6X7b/S9yT4a2p2l7gE8z/4n5A7R1gLg5t8i/F5L5N5O5Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .content {
            padding: 30px;
        }

        /* Estils per a les pestanyes */
        .tabs {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 20px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease, border-bottom 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-button:hover {
            color: #2a5298;
        }

        .tab-button.active {
            color: #2a5298;
            border-bottom: 2px solid #2a5298;
        }

        .tab-content {
            padding: 10px 0;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Estils existents */
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #2a5298;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        select, input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        /* Afegeix un estil per als camps deshabilitats per fer-los m√©s evidents */
        select:disabled, input:disabled, textarea:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(42, 82, 152, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #4a5568;
        }
        .btn-secondary:hover {
            background: #e2e8f0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            color: #2d3748;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #buttonGroup {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }


        .student-info {
            margin-top: 30px;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            table-layout: fixed; /* Important for fixed column widths */
        }
        
        .records-table th, .records-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word; /* Allows long text to wrap */
        }
        
        .records-table th {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            font-weight: 600;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }
        
        /* Mides de les columnes ajustades segons la teva petici√≥ */
        #studentRecordsTable th:nth-child(1), #studentRecordsTable td:nth-child(1) { width: 15%; } /* Data */
        #studentRecordsTable th:nth-child(2), #studentRecordsTable td:nth-child(2) { width: 15%; } /* Tipus */
        #studentRecordsTable th:nth-child(3), #studentRecordsTable td:nth-child(3) { width: 70%; } /* Anotaci√≥ */
        
        #allStudentRecordsTable th:nth-child(1), #allStudentRecordsTable td:nth-child(1) { width: 12%; } /* Data */
        #allStudentRecordsTable th:nth-child(2), #allStudentRecordsTable td:nth-child(2) { width: 15%; } /* Curs */
        #allStudentRecordsTable th:nth-child(3), #allStudentRecordsTable td:nth-child(3) { width: 18%; } /* Ensenyament */
        #allStudentRecordsTable th:nth-child(4), #allStudentRecordsTable td:nth-child(4) { width: 15%; } /* Tipus */
        #allStudentRecordsTable th:nth-child(5), #allStudentRecordsTable td:nth-child(5) { width: 40%; } /* Anotaci√≥ */
        
        #groupRecordsTable th:nth-child(1), #groupRecordsTable td:nth-child(1) { width: 15%; } /* Data */
        #groupRecordsTable th:nth-child(2), #groupRecordsTable td:nth-child(2) { width: 25%; } /* Alumne */
        #groupRecordsTable th:nth-child(3), #groupRecordsTable td:nth-child(3) { width: 15%; } /* Tipus */
        #groupRecordsTable th:nth-child(4), #groupRecordsTable td:nth-child(4) { width: 45%; } /* Anotaci√≥ */
        
        #diariClassTable th:nth-child(1), #diariClassTable td:nth-child(1) { width: 25%; } /* Alumne */
        #diariClassTable th:nth-child(2), #diariClassTable td:nth-child(2) { width: 20%; } /* Tipus */
        #diariClassTable th:nth-child(3), #diariClassTable td:nth-child(3) { width: 55%; } /* Anotaci√≥ */
        
        .diari-anotacio-textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px;
        }

        .tipo-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tipo-academic { background: #e3f2fd; color: #1976d2; }
        .tipo-social { background: #f3e5f5; color: #7b1fa2; }
        .tipo-absentisme { background: #fff3e0; color: #f57c00; }
        .tipo-baixa { background: #ffebee; color: #d32f2f; }
        .tipo-derivacio { background: #e8f5e8; color: #388e3c; }
        .tipo-tutoria { background: #e0f7fa; color: #00796b; }
        .tipo-default { background: #e1e5e9; color: #666; }


        .new-record-form {
            background: #fff;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
        }
        
        .ai-output-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            border-left: 5px solid #764ba2;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content, .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        /* Estils actualitzats per a la caixa de di√†leg de Gemini */
        .modal-content.text-left {
            text-align: left;
            display: flex;
            flex-direction: column;
            max-height: 90vh; /* Limita l'al√ßada del modal al 90% del viewport */
        }
        
        .modal-content.text-left .output-box {
            background-color: #e2f3ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            text-align: left;
            flex-grow: 1; /* Permet que la caixa creixi per omplir l'espai */
            overflow-y: auto; /* Afegeix despla√ßament si el contingut √©s massa llarg */
            max-height: 50vh; /* Limita l'al√ßada de la caixa de text per mantenir el bot√≥ visible */
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .loading-overlay {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5); /* Fons opac per a un millor contrast */
            z-index: 2000;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .message-container {
            margin-bottom: 20px;
        }

        .message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: block;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            border: 1px solid #d32f2f;
        }

        .success {
            color: #388e3c;
            background: #e8f5e8;
            border: 1px solid #388e3c;
        }
        
        .add-alumne-btn {
            background-color: #4CAF50;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .add-alumne-btn:hover {
            background-color: #45a049;
        }
        
        .diari-alumne-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flex-end {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

    </style>
</head>
<body>
    <!-- Modal de c√†rrega m√©s prominent -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingMessage" style="color: #1e3c72;">Carregant...</h3>
        </div>
    </div>
    
    <!-- Modal per a la resposta de l'IA -->
    <div id="geminiOutputModal" class="confirmation-modal hidden">
        <div class="modal-content text-left">
            <h3 class="text-xl font-bold mb-4" id="geminiOutputTitle"></h3>
            <div class="output-box" id="geminiOutputContent"></div>
            <div class="mt-5 text-right">
                <button class="btn btn-secondary" onclick="hideGeminiOutput()">Tancar</button>
            </div>
        </div>
    </div>


    <div class="container">
        <div class="header">
            <h1>üéì CFA La Pau</h1>
            <p>Sistema de Seguiment d'Alumnes</p>
        </div>

        <div class="content">
            <!-- Contenidor per a missatges d'error i √®xit -->
            <div id="messageContainer" class="message-container"></div>
            
            <!-- Interf√≠cie de pestanyes -->
            <div class="tabs">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showTab('alumne-curs')">Alumne d'un curs</button>
                    <button class="tab-button" onclick="showTab('alumnes')">Alumnes</button>
                    <button class="tab-button" onclick="showTab('grups')">Grups</button>
                    <!-- PESTANYA: Diari de Classe -->
                    <button class="tab-button" onclick="showTab('diari')">Diari de Classe</button>
                </div>
                
                <div id="tab-alumne-curs" class="tab-content">
                    <div class="form-section">
                        <h2>Selecciona Alumne per Curs i Ensenyament</h2>
                        <div class="form-group">
                            <label for="cursSelect">Curs Acad√®mic:</label>
                            <select id="cursSelect">
                                <!-- Opcions seran poblades din√†micament -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ensenyamentSelect">Ensenyament:</label>
                            <select id="ensenyamentSelect" disabled>
                                <option value="">Selecciona primer un curs</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="alumneSelect">Alumne:</label>
                            <select id="alumneSelect" disabled>
                                <option value="">Selecciona primer un ensenyament</option>
                            </select>
                        </div>
                    </div>
                    <div id="studentInfo" class="student-info hidden">
                        <div class="form-section">
                            <h2 id="studentName">Informaci√≥ de l'Alumne</h2>
                            <button id="generateGeminiBtn" class="btn mt-4">Generar resum i suggeriment d'acci√≥ ‚ú®</button>
                            <div id="studentRecordsContainer">
                                <table class="records-table" id="studentRecordsTable">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Tipus</th>
                                            <th>Anotaci√≥</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentRecordsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Formulari per afegir nova anotaci√≥ per a alumne d'un curs -->
                        <div id="form-alumne-curs" class="new-record-form">
                            <h3>Afegir Nova Anotaci√≥</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="formCurs_alumneCurs">Curs:</label>
                                    <input type="text" id="formCurs_alumneCurs" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="formEnsenyament_alumneCurs">Ensenyament:</label>
                                    <input type="text" id="formEnsenyament_alumneCurs" disabled>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="formAlumne_alumneCurs">Alumne:</label>
                                    <input type="text" id="formAlumne_alumneCurs" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="newRecordDate_alumneCurs">Data:</label>
                                    <input type="date" id="newRecordDate_alumneCurs" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="newRecordType_alumneCurs">Tipus:</label>
                                <select id="newRecordType_alumneCurs" required>
                                    <option value="">Selecciona tipus</option>
                                    <option value="Acad√®mic">Acad√®mic</option>
                                    <option value="Social">Social</option>
                                    <option value="Absentisme">Absentisme</option>
                                    <option value="Baixa">Baixa</option>
                                    <option value="Derivaci√≥">Derivaci√≥</option>
                                    <option value="Tutoria">Tutoria</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newRecordNote_alumneCurs">Anotaci√≥:</label>
                                <textarea id="newRecordNote_alumneCurs" rows="3" placeholder="Escriu l'anotaci√≥..." required></textarea>
                            </div>
                            <button class="add-record-btn btn">Afegir Anotaci√≥</button>
                        </div>
                    </div>
                </div>

                <div id="tab-alumnes" class="tab-content hidden">
                    <div class="form-section">
                        <h2>Selecciona un Alumne de l'Escola</h2>
                        <div class="form-group">
                            <label for="allAlumneSelect">Alumne:</label>
                            <select id="allAlumneSelect">
                                <option value="">Selecciona un alumne</option>
                            </select>
                        </div>
                    </div>
                    <div id="allStudentRecordsContainer" class="student-info hidden">
                         <div class="form-section">
                            <h2 id="allStudentName"></h2>
                            <table class="records-table" id="allStudentRecordsTable">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Curs</th>
                                        <th>Ensenyament</th>
                                        <th>Tipus</th>
                                        <th>Anotaci√≥</th>
                                    </tr>
                                </thead>
                                <tbody id="allStudentRecordsTableBody">
                                </tbody>
                            </table>
                        </div>

                        <!-- Formulari per afegir nova anotaci√≥ per a un alumne de l'escola -->
                        <div id="form-alumnes" class="new-record-form">
                            <h3>Afegir Nova Anotaci√≥</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="formCurs_alumnes">Curs:</label>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="formCurs_alumnes" style="flex: 1;">
                                            <option value="">Selecciona curs</option>
                                        </select>
                                        <input type="text" id="newCurs_alumnes" placeholder="Nou curs (ex: 2027-28)" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="formEnsenyament_alumnes">Ensenyament:</label>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="formEnsenyament_alumnes" style="flex: 1;">
                                            <option value="">Selecciona ensenyament</option>
                                        </select>
                                        <input type="text" id="newEnsenyament_alumnes" placeholder="Nou ensenyament" style="flex: 1;">
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="formAlumne_alumnes">Alumne:</label>
                                    <input type="text" id="formAlumne_alumnes" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="newRecordDate_alumnes">Data:</label>
                                    <input type="date" id="newRecordDate_alumnes" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="newRecordType_alumnes">Tipus:</label>
                                <select id="newRecordType_alumnes" required>
                                    <option value="">Selecciona tipus</option>
                                    <option value="Acad√®mic">Acad√®mic</option>
                                    <option value="Social">Social</option>
                                    <option value="Absentisme">Absentisme</option>
                                    <option value="Baixa">Baixa</option>
                                    <option value="Derivaci√≥">Derivaci√≥</option>
                                    <option value="Tutoria">Tutoria</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newRecordNote_alumnes">Anotaci√≥:</label>
                                <textarea id="newRecordNote_alumnes" rows="3" placeholder="Escriu l'anotaci√≥..." required></textarea>
                            </div>
                            <button class="add-record-btn btn">Afegir Anotaci√≥</button>
                        </div>
                    </div>
                </div>

                <div id="tab-grups" class="tab-content hidden">
                    <div class="form-section">
                        <h2>Anotaci√≥ per a Grups</h2>
                        <!-- Selector de mode de grup -->
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="groupMode" value="existing" checked>
                                <span>Selecciona Grup Existent</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="groupMode" value="new">
                                <span>Crear Nou Grup</span>
                            </label>
                        </div>

                        <!-- Formulari per a grups existents -->
                        <div id="existingGroupForm">
                            <div class="form-group">
                                <label for="groupCursSelect">Curs Acad√®mic:</label>
                                <select id="groupCursSelect">
                                    <!-- Opcions seran poblades din√†micament -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="groupEnsenyamentSelect">Ensenyament:</label>
                                <select id="groupEnsenyamentSelect" disabled>
                                    <option value="">Selecciona primer un curs</option>
                                </select>
                            </div>
                        </div>

                        <!-- Formulari per a grups nous, ocult per defecte -->
                        <div id="newGroupForm" class="hidden">
                            <div class="form-group">
                                <label for="newGroupCursSelect">Curs Acad√®mic:</label>
                                <select id="newGroupCursSelect">
                                    <!-- Opcions seran poblades din√†micament -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newGroupEnsenyamentInput">Ensenyament:</label>
                                <input type="text" id="newGroupEnsenyamentInput" placeholder="Nom del nou ensenyament">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contenidor per a la taula d'alumnes del grup existent -->
                    <div id="groupInfo" class="student-info hidden">
                        <div class="form-section">
                            <h2 id="groupName"></h2>
                            <div id="groupRecordsContainer">
                                <table class="records-table" id="groupRecordsTable">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Alumne</th>
                                            <th>Tipus</th>
                                            <th>Anotaci√≥</th>
                                        </tr>
                                    </thead>
                                    <tbody id="groupRecordsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Formulari per afegir nova anotaci√≥ per a un grup (existent o nou) -->
                    <div id="form-grups" class="new-record-form">
                        <h3>Afegir Nova Anotaci√≥</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="formCurs_grups">Curs:</label>
                                <input type="text" id="formCurs_grups" disabled>
                            </div>
                            <div class="form-group">
                                <label for="formEnsenyament_grups">Ensenyament:</label>
                                <input type="text" id="formEnsenyament_grups" disabled>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="formAlumne_grups">Alumne:</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="formAlumne_grups" style="flex: 1;">
                                        <option value="">Selecciona alumne</option>
                                    </select>
                                    <input type="text" id="newAlumne_grups" placeholder="Nou alumne" style="flex: 1;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="newRecordDate_grups">Data:</label>
                                <input type="date" id="newRecordDate_grups" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newRecordType_grups">Tipus:</label>
                            <select id="newRecordType_grups" required>
                                <option value="">Selecciona tipus</option>
                                <option value="Acad√®mic">Acad√®mic</option>
                                <option value="Social">Social</option>
                                <option value="Absentisme">Absentisme</option>
                                <option value="Baixa">Baixa</option>
                                <option value="Derivaci√≥">Derivaci√≥</option>
                                <option value="Tutoria">Tutoria</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newRecordNote_grups">Anotaci√≥:</label>
                            <textarea id="newRecordNote_grups" rows="3" placeholder="Escriu l'anotaci√≥..." required></textarea>
                        </div>
                        <button class="add-record-btn btn">Afegir Anotaci√≥</button>
                    </div>
                </div>

                <!-- SECCI√ì DE CONTINGUT: DIARI DE CLASSE -->
                <div id="tab-diari" class="tab-content hidden">
                    <div class="form-section">
                        <h2>Diari de Classe</h2>
                        <p class="mb-4">Afegiu anotacions per a tota la classe d'un dia concret.</p>
                        <div class="form-group">
                            <label for="diariCursSelect">Curs Acad√®mic:</label>
                            <select id="diariCursSelect">
                                <!-- Opcions seran poblades din√†micament -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="diariEnsenyamentSelect">Ensenyament:</label>
                            <select id="diariEnsenyamentSelect" disabled>
                                <option value="">Selecciona primer un curs</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="diariDataSelect">Data de l'anotaci√≥:</label>
                            <input type="date" id="diariDataSelect">
                        </div>
                    </div>
                    <!-- Contenidor per a la taula d'anotacions del diari -->
                    <div id="diariAnotacionsTableContainer" class="hidden">
                        <div class="form-section">
                            <h4 class="text-xl font-bold mb-4">Anotacions per a: <span id="diariGroupName"></span></h4>
                            <div class="flex flex-col md:flex-row md:items-center md:gap-4 mb-4">
                                <div class="form-group flex-1 m-0">
                                    <label for="duplicateAlumneSelect">Duplicar alumne:</label>
                                    <div class="flex">
                                        <select id="duplicateAlumneSelect" class="flex-grow">
                                            <option value="">Selecciona un alumne</option>
                                        </select>
                                        <button id="addDuplicateAlumneBtn" class="btn ml-2 p-2 px-4 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white font-semibold flex items-center justify-center transition-all duration-200">
                                            Afegir
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <table class="records-table" id="diariClassTable">
                                <thead>
                                    <tr>
                                        <th>Alumne</th>
                                        <th>Tipus</th>
                                        <th>Anotaci√≥</th>
                                    </tr>
                                </thead>
                                <tbody id="diariClassTableBody">
                                    <!-- Aqu√≠ s'injectaran les files dels alumnes -->
                                </tbody>
                            </table>
                            <div class="mt-4 flex-between">
                                <button id="addAlumneBtn" class="btn btn-secondary flex items-center gap-2">+ Afegir alumne</button>
                                <button id="diariSubmitBtn" class="btn">Afegir Anotacions</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥ -->
    <div id="confirmationModal" class="confirmation-modal hidden">
        <div class="modal-content text-left">
            <h3>Confirmar Noves Anotacions</h3>
            <div id="confirmationDetails"></div>
            <div style="margin-top: 20px;" class="text-right">
                <button id="confirmAddBtn" class="btn">Confirmar</button>
                <button id="cancelAddBtn" class="btn btn-secondary">Cancel¬∑lar</button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥ de l'API de Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGCVet2879gYZ3iLsvKiIQB0FuDR6sF8gF-H_QPS8pRuUGjwuhXtdL4LpQStyLjvx7/exec';
        const SHEET_ID = '1FWhKB7yu3rPFHMI8_Vzlqd1YzE68x86ZmuuV6Bbw55w';
        const FULL = 'Taula';

        // Variables globals per a les dades i l'estat actual
        let allData = [];
        let activeTabId = 'alumne-curs'; // Pestanya activa per defecte
        
        // C√†rrega inicial de dades per a tots els men√∫s i taules.
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            setTodayDate();
            setupEventListeners();
        });

        // Funci√≥ per a carregar totes les dades del servidor un cop
        // al carregar la p√†gina. Despr√©s, les actualitzacions seran locals.
        async function loadInitialData() {
            clearMessages();
            try {
                showLoading('Carregant dades inicials...');
                const url = `${SCRIPT_URL}?action=read&sheetId=${SHEET_ID}&sheetName=${FULL}`;
                
                const data = await makeJSONPRequest(url);

                if (data && data.success) {
                    const headers = data.data.shift();
                    allData = data.data.map(row => {
                        let obj = {};
                        headers.forEach((header, i) => {
                            obj[header] = row[i];
                        });
                        return obj;
                    });
                    
                    console.log('Dades inicials carregades correctament:', allData.length, 'registres');
                    
                    // Omplim els men√∫s desplegables de totes les pestanyes
                    populateAllDropdowns();
                    
                    // Inicialitzem la taula de la pestanya activa
                    updateCurrentTabView();

                } else {
                    throw new Error(data ? data.message : 'Resposta inv√†lida del servidor');
                }
            } catch (error) {
                console.error('Error carregant dades inicials:', error);
                showError('Error de connexi√≥: ' + error.message + '. Si us plau, comprova la consola del navegador per a m√©s detalls.');
            } finally {
                hideLoading();
            }
        }
        
        // Funci√≥ per a les peticions JSONP
        function makeJSONPRequest(url) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                let script = null;
                let timeoutId = null;
                
                const cleanup = () => {
                    if (script && script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                    }
                };
                
                try {
                    script = document.createElement('script');
                    const finalUrl = new URL(url);
                    finalUrl.searchParams.append('callback', callbackName);
                    
                    console.log('JSONP URL:', finalUrl.toString());
                    script.src = finalUrl.toString();
                    
                    window[callbackName] = function(data) {
                        cleanup();
                        console.log('JSONP resposta rebuda:', data);
                        resolve(data);
                    };
                    
                    script.onerror = function(error) {
                        cleanup();
                        console.error('Error JSONP script:', error);
                        reject(new Error('Error carregant l\'script JSONP'));
                    };
                    
                    timeoutId = setTimeout(() => {
                        cleanup();
                        reject(new Error('Timeout de la petici√≥ JSONP (15s)'));
                    }, 15000);
                    
                    document.head.appendChild(script);
                } catch (error) {
                    cleanup();
                    reject(error);
                }
            });
        }
        
        // Funci√≥ per omplir tots els dropdowns un cop carregades les dades.
        function populateAllDropdowns() {
            populateMainCursos();
            populateAllAlumnes();
            populateGroupCursos();
            populateDiariCursos();
            populateFormCursos('alumnes');
            populateFormEnsenyaments('alumnes');
            // Populamos los nuevos dropdowns de la pesta√±a Grups
            populateNewGroupCursos();
            populateGroupFormAlumnes();
        }

        // Funci√≥ per actualitzar la vista de la pestanya actual
        function updateCurrentTabView() {
            if (activeTabId === 'alumne-curs') {
                if (alumneSelect.value) {
                    loadStudentInfo();
                }
            } else if (activeTabId === 'alumnes') {
                if (allAlumneSelect.value) {
                    loadAllStudentRecords();
                }
            } else if (activeTabId === 'grups') {
                onGroupModeChange(); // Inicia la vista de grupos en el modo predeterminado
            } else if (activeTabId === 'diari') {
                if (diariCursSelect.value && diariEnsenyamentSelect.value) {
                    onDiariEnsenyamentChange();
                }
            }
        }
        
        // --- Funcions per a la pestanya "Alumne d'un curs" ---
        const cursSelect = document.getElementById('cursSelect');
        const ensenyamentSelect = document.getElementById('ensenyamentSelect');
        const alumneSelect = document.getElementById('alumneSelect');
        const studentInfo = document.getElementById('studentInfo');
        const studentName = document.getElementById('studentName');
        const studentRecordsTableBody = document.getElementById('studentRecordsTableBody');
        const generateGeminiBtn = document.getElementById('generateGeminiBtn');

        function populateMainCursos() {
            const cursos = [...new Set(allData.map(row => row.Curs))].filter(Boolean).sort();
            cursSelect.innerHTML = '<option value="">Selecciona curs</option>';
            cursos.forEach(curs => {
                const option = document.createElement('option');
                option.value = curs;
                option.textContent = curs;
                cursSelect.appendChild(option);
            });
        }
        
        function onCursChange() {
            populateMainEnsenyaments();
            ensenyamentSelect.value = '';
            alumneSelect.value = '';
            studentInfo.classList.add('hidden');
        }

        function populateMainEnsenyaments() {
            const curs = cursSelect.value;
            const ensenyaments = [...new Set(allData
                .filter(row => row.Curs === curs)
                .map(row => row.Ensenyament))
            ].filter(Boolean).sort();

            ensenyamentSelect.innerHTML = '<option value="">Selecciona ensenyament</option>';
            ensenyaments.forEach(ensenyament => {
                const option = document.createElement('option');
                option.value = ensenyament;
                option.textContent = ensenyament;
                ensenyamentSelect.appendChild(option);
            });
            ensenyamentSelect.disabled = ensenyaments.length === 0;
        }

        function onEnsenyamentChange() {
            populateMainAlumnes();
            alumneSelect.value = '';
            studentInfo.classList.add('hidden');
        }

        function populateMainAlumnes() {
            const curs = cursSelect.value;
            const ensenyament = ensenyamentSelect.value;
            
            if (!ensenyament) {
                resetMainAlumnes();
                return;
            }
            const alumnes = [...new Set(allData
                .filter(row => row.Curs === curs && row.Ensenyament === ensenyament)
                .map(row => row.Alumne))
            ].filter(Boolean).sort();

            alumneSelect.innerHTML = '<option value="">Selecciona alumne</option>';
            alumnes.forEach(alumne => {
                const option = document.createElement('option');
                option.value = alumne;
                option.textContent = alumne;
                alumneSelect.appendChild(option);
            });
            alumneSelect.disabled = alumnes.length === 0;
        }

        function resetMainAlumnes() {
            alumneSelect.innerHTML = '<option value="">Selecciona primer un ensenyament</option>';
            alumneSelect.disabled = true;
        }
        
        function loadStudentInfo() {
            clearMessages();
            const selectedAlumne = alumneSelect.value;
            if (!selectedAlumne) {
                studentInfo.classList.add('hidden');
                return;
            }

            const studentRecords = allData.filter(row => 
                row.Curs === cursSelect.value &&
                row.Ensenyament === ensenyamentSelect.value &&
                row.Alumne === selectedAlumne
            );

            studentRecords.sort((a, b) => {
                const dateA = parseDate(a.Data);
                const dateB = parseDate(b.Data);
                return dateB - dateA; // M√©s recent primer
            });

            studentName.textContent = `${selectedAlumne} - ${ensenyamentSelect.value} (${cursSelect.value})`;
            
            // Renderitzem tota la taula
            renderTable(studentRecords, 'studentRecordsTableBody', ['Data', 'Tipus', 'Anotaci√≥']);
            
            studentInfo.classList.remove('hidden');

            // Omplir i deshabilitar els camps del formulari
            document.getElementById('formCurs_alumneCurs').value = cursSelect.value;
            document.getElementById('formEnsenyament_alumneCurs').value = ensenyamentSelect.value;
            document.getElementById('formAlumne_alumneCurs').value = selectedAlumne;
            setTodayDate();

            // Activem el bot√≥ de Gemini si hi ha anotacions
            generateGeminiBtn.disabled = studentRecords.length === 0;
        }
        
        // --- Funcions per a la pestanya "Alumnes" ---
        const allAlumneSelect = document.getElementById('allAlumneSelect');
        const allStudentRecordsContainer = document.getElementById('allStudentRecordsContainer');
        const allStudentName = document.getElementById('allStudentName');
        const allStudentRecordsTableBody = document.getElementById('allStudentRecordsTableBody');
        const formCursAlumnes = document.getElementById('formCurs_alumnes');
        const formEnsenyamentAlumnes = document.getElementById('formEnsenyament_alumnes');
        const newCursAlumnes = document.getElementById('newCurs_alumnes');
        const newEnsenyamentAlumnes = document.getElementById('newEnsenyament_alumnes');

        function populateAllAlumnes() {
            const allAlumnes = [...new Set(allData.map(row => row.Alumne))].filter(Boolean).sort();
            allAlumneSelect.innerHTML = '<option value="">Selecciona un alumne</option>';
            allAlumnes.forEach(alumne => {
                const option = document.createElement('option');
                option.value = alumne;
                option.textContent = alumne;
                allAlumneSelect.appendChild(option);
            });
            return allAlumnes;
        }
        
        function loadAllStudentRecords() {
            clearMessages();
            const selectedAlumne = allAlumneSelect.value;
            if (!selectedAlumne) {
                allStudentRecordsContainer.classList.add('hidden');
                return;
            }
            
            const studentRecords = allData.filter(row => row.Alumne === selectedAlumne);
            studentRecords.sort((a, b) => {
                const dateA = parseDate(a.Data);
                const dateB = parseDate(b.Data);
                return dateB - dateA; // M√©s recent primer
            });
            
            allStudentName.textContent = `Registres per a ${selectedAlumne}`;
            
            renderTable(studentRecords, 'allStudentRecordsTableBody', ['Data', 'Curs', 'Ensenyament', 'Tipus', 'Anotaci√≥']);
            
            allStudentRecordsContainer.classList.remove('hidden');

            // Omplir i deshabilitar el camp d'alumne del formulari
            document.getElementById('formAlumne_alumnes').value = selectedAlumne;
            populateFormCursos('alumnes');
            populateFormEnsenyaments('alumnes');
            setTodayDate();
        }
        
        function populateFormCursos(tab) {
            const cursSelect = document.getElementById(`formCurs_${tab}`);
            const cursos = [...new Set(allData.map(row => row.Curs))].filter(Boolean).sort();
            cursSelect.innerHTML = '<option value="">Selecciona curs</option>';
            cursos.forEach(curs => {
                const option = document.createElement('option');
                option.value = curs;
                option.textContent = curs;
                cursSelect.appendChild(option);
            });
        }
        
        function populateFormEnsenyaments(tab) {
            const cursSelect = document.getElementById(`formCurs_${tab}`);
            const newCursInput = document.getElementById(`newCurs_${tab}`);
            const ensenyamentSelect = document.getElementById(`formEnsenyament_${tab}`);
            const selectedCurs = newCursInput.value.trim() || cursSelect.value;
            
            if (!selectedCurs) {
                ensenyamentSelect.innerHTML = '<option value="">Selecciona primer un curs</option>';
                return;
            }
            
            const ensenyaments = [...new Set(allData
                .filter(row => row.Curs === selectedCurs)
                .map(row => row.Ensenyament))
            ].filter(Boolean).sort();

            ensenyamentSelect.innerHTML = '<option value="">Selecciona ensenyament</option>';
            ensenyaments.forEach(ensenyament => {
                const option = document.createElement('option');
                option.value = ensenyament;
                option.textContent = ensenyament;
                ensenyamentSelect.appendChild(option);
            });
        }


        // --- Funcions per a la pestanya "Grups" ---
        const groupCursSelect = document.getElementById('groupCursSelect');
        const groupEnsenyamentSelect = document.getElementById('groupEnsenyamentSelect');
        const groupInfo = document.getElementById('groupInfo');
        const groupName = document.getElementById('groupName');
        const groupRecordsTableBody = document.getElementById('groupRecordsTableBody');
        const formAlumneGrups = document.getElementById('formAlumne_grups');
        const newGroupCursSelect = document.getElementById('newGroupCursSelect');
        const newGroupEnsenyamentInput = document.getElementById('newGroupEnsenyamentInput');
        const existingGroupForm = document.getElementById('existingGroupForm');
        const newGroupForm = document.getElementById('newGroupForm');
        
        let groupMode = 'existing'; // Estado del modo de grupo

        function onGroupModeChange() {
            const selectedMode = document.querySelector('input[name="groupMode"]:checked').value;
            groupMode = selectedMode;
            
            if (groupMode === 'existing') {
                existingGroupForm.classList.remove('hidden');
                newGroupForm.classList.add('hidden');
                groupInfo.classList.add('hidden'); // Ocultar tabla de registros
                onGroupCursChange(); // Cargar datos de grupo existente
            } else {
                existingGroupForm.classList.add('hidden');
                newGroupForm.classList.remove('hidden');
                groupInfo.classList.add('hidden');
                
                // Reiniciar y poblar selectores para el nuevo grupo
                populateNewGroupCursos();
                populateGroupFormAlumnes();
                setFormGrupsFields('', '', '');
            }
        }
        
        function populateGroupFormAlumnes() {
            const allAlumnes = [...new Set(allData.map(row => row.Alumne))].filter(Boolean).sort();
            formAlumneGrups.innerHTML = '<option value="">Selecciona alumne</option>';
            allAlumnes.forEach(alumne => {
                const option = document.createElement('option');
                option.value = alumne;
                option.textContent = alumne;
                formAlumneGrups.appendChild(option);
            });
        }

        function populateGroupCursos() {
            const cursos = [...new Set(allData.map(row => row.Curs))].filter(Boolean).sort();
            groupCursSelect.innerHTML = '<option value="">Selecciona curs</option>';
            cursos.forEach(curs => {
                const option = document.createElement('option');
                option.value = curs;
                option.textContent = curs;
                groupCursSelect.appendChild(option);
            });
        }
        
        function populateNewGroupCursos() {
            const cursos = [...new Set(allData.map(row => row.Curs))].filter(Boolean).sort();
            newGroupCursSelect.innerHTML = '<option value="">Selecciona curs</option>';
            cursos.forEach(curs => {
                const option = document.createElement('option');
                option.value = curs;
                option.textContent = curs;
                newGroupCursSelect.appendChild(option);
            });
        }

        function onGroupCursChange() {
            const selectedCurs = groupCursSelect.value;
            const ensenyaments = [...new Set(allData
                .filter(row => row.Curs === selectedCurs)
                .map(row => row.Ensenyament))
            ].filter(Boolean).sort();
            groupEnsenyamentSelect.innerHTML = '<option value="">Selecciona ensenyament</option>';
            ensenyaments.forEach(ensenyament => {
                const option = document.createElement('option');
                option.value = ensenyament;
                option.textContent = ensenyament;
                groupEnsenyamentSelect.appendChild(option);
            });
            groupEnsenyamentSelect.disabled = ensenyaments.length === 0;
            groupInfo.classList.add('hidden');
        }

        function onGroupEnsenyamentChange() {
            clearMessages();
            const selectedCurs = groupCursSelect.value;
            const selectedEnsenyament = groupEnsenyamentSelect.value;
            if (!selectedCurs || !selectedEnsenyament) {
                groupInfo.classList.add('hidden');
                return;
            }

            const groupRecords = allData.filter(row =>
                row.Curs === selectedCurs &&
                row.Ensenyament === selectedEnsenyament
            );

            // Ordenaci√≥: per Alumne (alfab√®tic) i despr√©s per Data (m√©s antic a m√©s recent)
            groupRecords.sort((a, b) => {
                const alumneCompare = a.Alumne.localeCompare(b.Alumne);
                if (alumneCompare !== 0) {
                    return alumneCompare;
                }
                const dateA = parseDate(a.Data);
                const dateB = parseDate(b.Data);
                return dateA - dateB;
            });

            groupName.textContent = `Registres per al grup: ${selectedEnsenyament} (${selectedCurs})`;
            
            renderTable(groupRecords, 'groupRecordsTableBody', ['Data', 'Alumne', 'Tipus', 'Anotaci√≥']);
            
            groupInfo.classList.remove('hidden');

            // Omplir i deshabilitar els camps de curs i ensenyament del formulari
            setFormGrupsFields(selectedCurs, selectedEnsenyament);
            populateGroupFormAlumnes(selectedCurs, selectedEnsenyament);
            setTodayDate();
        }
        
        function setFormGrupsFields(curs, ensenyament) {
            document.getElementById('formCurs_grups').value = curs;
            document.getElementById('formEnsenyament_grups').value = ensenyament;
        }

        function populateFormAlumnes(curs, ensenyament) {
            const alumnes = [...new Set(allData
                .filter(row => row.Curs === curs && row.Ensenyament === ensenyament)
                .map(row => row.Alumne))
            ].filter(Boolean).sort();
            
            formAlumneGrups.innerHTML = '<option value="">Selecciona alumne</option>';
            alumnes.forEach(alumne => {
                const option = document.createElement('option');
                option.value = alumne;
                option.textContent = alumne;
                formAlumneGrups.appendChild(option);
            });
        }
        
        // --- Funcions per a la nova pestanya "Diari" ---
        const diariCursSelect = document.getElementById('diariCursSelect');
        const diariEnsenyamentSelect = document.getElementById('diariEnsenyamentSelect');
        const diariDataSelect = document.getElementById('diariDataSelect');
        const diariAnotacionsTableContainer = document.getElementById('diariAnotacionsTableContainer');
        const diariClassTableBody = document.getElementById('diariClassTableBody');
        const diariGroupName = document.getElementById('diariGroupName');
        const duplicateAlumneSelect = document.getElementById('duplicateAlumneSelect');

        function populateDiariCursos() {
            const cursos = [...new Set(allData.map(row => row.Curs))].filter(Boolean).sort();
            diariCursSelect.innerHTML = '<option value="">Selecciona curs</option>';
            cursos.forEach(curs => {
                const option = document.createElement('option');
                option.value = curs;
                option.textContent = curs;
                diariCursSelect.appendChild(option);
            });
        }
        
        function onDiariCursChange() {
            populateDiariEnsenyaments();
            diariEnsenyamentSelect.value = '';
            diariAnotacionsTableContainer.classList.add('hidden');
        }
        
        function populateDiariEnsenyaments() {
            const curs = diariCursSelect.value;
            const ensenyaments = [...new Set(allData
                .filter(row => row.Curs === curs)
                .map(row => row.Ensenyament))
            ].filter(Boolean).sort();

            diariEnsenyamentSelect.innerHTML = '<option value="">Selecciona ensenyament</option>';
            ensenyaments.forEach(ensenyament => {
                const option = document.createElement('option');
                option.value = ensenyament;
                option.textContent = ensenyament;
                diariEnsenyamentSelect.appendChild(option);
            });
            diariEnsenyamentSelect.disabled = ensenyaments.length === 0;
        }

        // Funci√≥ principal que genera la taula d'alumnes del diari
        function onDiariEnsenyamentChange() {
            const curs = diariCursSelect.value;
            const ensenyament = diariEnsenyamentSelect.value;
            
            if (!curs || !ensenyament) {
                diariAnotacionsTableContainer.classList.add('hidden');
                return;
            }

            const alumnes = [...new Set(allData
                .filter(row => row.Curs === curs && row.Ensenyament === ensenyament)
                .map(row => row.Alumne))
            ].filter(Boolean).sort();
            
            diariClassTableBody.innerHTML = '';
            if (alumnes.length > 0) {
                diariGroupName.textContent = `${ensenyament} (${curs})`;
                alumnes.forEach(alumne => {
                    const row = document.createElement('tr');
                    row.dataset.alumne = alumne;
                    row.innerHTML = `
                        <td>${alumne}</td>
                        <td>
                            <select class="diari-tipo-select" name="tipo-${alumne}">
                                <option value="">Selecciona tipus</option>
                                <option value="Acad√®mic">Acad√®mic</option>
                                <option value="Social">Social</option>
                                <option value="Absentisme">Absentisme</option>
                                <option value="Baixa">Baixa</option>
                                <option value="Derivaci√≥">Derivaci√≥</option>
                                <option value="Tutoria">Tutoria</option>
                            </select>
                        </td>
                        <td>
                            <textarea class="diari-anotacio-textarea" rows="2" name="anotacio-${alumne}"></textarea>
                        </td>
                    `;
                    diariClassTableBody.appendChild(row);
                });
                // Popular el dropdown de duplicar alumne
                populateDuplicateAlumneSelect(alumnes);
                diariAnotacionsTableContainer.classList.remove('hidden');
            } else {
                diariAnotacionsTableContainer.classList.add('hidden');
            }
        }
        
        /**
         * Popula el dropdown de "Duplicar alumne" amb els alumnes del grup actual.
         */
        function populateDuplicateAlumneSelect(alumnes) {
            duplicateAlumneSelect.innerHTML = '<option value="">Selecciona un alumne</option>';
            alumnes.forEach(alumne => {
                const option = document.createElement('option');
                option.value = alumne;
                option.textContent = alumne;
                duplicateAlumneSelect.appendChild(option);
            });
        }
        
        /**
         * Afegeix una nova fila a la taula del diari per crear un nou alumne.
         */
        function addNewDiariAlumneRow() {
            const tableBody = document.getElementById('diariClassTableBody');
            const row = document.createElement('tr');
            row.classList.add('new-alumne-row'); // Afegim una classe per identificar-lo
            row.innerHTML = `
                <td>
                    <input type="text" class="diari-alumne-input" placeholder="Nom del nou alumne" required>
                </td>
                <td>
                    <select class="diari-tipo-select" required>
                        <option value="">Selecciona tipus</option>
                        <option value="Acad√®mic">Acad√®mic</option>
                        <option value="Social">Social</option>
                        <option value="Absentisme">Absentisme</option>
                        <option value="Baixa">Baixa</option>
                        <option value="Derivaci√≥">Derivaci√≥</option>
                        <option value="Tutoria">Tutoria</option>
                    </select>
                </td>
                <td>
                    <textarea class="diari-anotacio-textarea" rows="2"></textarea>
                </td>
            `;
            tableBody.appendChild(row);
        }
        
        /**
         * Afegeix una nova fila a la taula del diari per duplicar un alumne existent.
         */
        function addDuplicateAlumneRow() {
            const alumne = duplicateAlumneSelect.value;
            if (!alumne) {
                showError('Si us plau, selecciona un alumne per duplicar.');
                return;
            }
            
            const tableBody = document.getElementById('diariClassTableBody');
            const row = document.createElement('tr');
            row.dataset.alumne = alumne;
            row.innerHTML = `
                <td>${alumne}</td>
                <td>
                    <select class="diari-tipo-select" name="tipo-${alumne}">
                        <option value="">Selecciona tipus</option>
                        <option value="Acad√®mic">Acad√®mic</option>
                        <option value="Social">Social</option>
                        <option value="Absentisme">Absentisme</option>
                        <option value="Baixa">Baixa</option>
                        <option value="Derivaci√≥">Derivaci√≥</option>
                        <option value="Tutoria">Tutoria</option>
                    </select>
                </td>
                <td>
                    <textarea class="diari-anotacio-textarea" rows="2" name="anotacio-${alumne}"></textarea>
                </td>
            `;
            tableBody.appendChild(row);
            
            // Reiniciar el dropdown de duplicar
            duplicateAlumneSelect.value = "";
        }
        
        // --- Funci√≥ gen√®rica per renderitzar una taula ---
        function renderTable(data, tableBodyId, headers) {
            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = '';

            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="${headers.length}" style="text-align: center; font-style: italic; color: #666;">No hi ha registres</td>`;
                tableBody.appendChild(row);
            } else {
                data.forEach(record => {
                    const row = createTableRow(record, headers);
                    tableBody.appendChild(row);
                });
            }
        }
        
        // --- Funci√≥ per crear una fila de taula (per a renderitzaci√≥ i addici√≥) ---
        function createTableRow(record, headers) {
            const row = document.createElement('tr');
            
            // Per a la taula d'alumnes d'un curs, no mostrem totes les dades
            if (headers.length === 3) {
                const tipoClass = getTipoClass(record.Tipus);
                row.innerHTML = `
                    <td>${formatDate(record.Data)}</td>
                    <td><span class="tipo-badge ${tipoClass}">${record.Tipus || 'N/A'}</span></td>
                    <td>${record.Anotaci√≥ || 'Sense anotaci√≥'}</td>
                `;
            } else if (headers.length === 5) {
                 const tipoClass = getTipoClass(record.Tipus);
                 row.innerHTML = `
                    <td>${formatDate(record.Data)}</td>
                    <td>${record.Curs || 'N/A'}</td>
                    <td>${record.Ensenyament || 'N/A'}</td>
                    <td><span class="tipo-badge ${tipoClass}">${record.Tipus || 'N/A'}</span></td>
                    <td>${record.Anotaci√≥ || 'Sense anotaci√≥'}</td>
                `;
            } else if (headers.length === 4) {
                 const tipoClass = getTipoClass(record.Tipus);
                 row.innerHTML = `
                    <td>${formatDate(record.Data)}</td>
                    <td>${record.Alumne || 'N/A'}</td>
                    <td><span class="tipo-badge ${tipoClass}">${record.Tipus || 'N/A'}</span></td>
                    <td>${record.Anotaci√≥ || 'Sense anotaci√≥'}</td>
                `;
            }
            
            return row;
        }


        // --- Funci√≥ principal per afegir una nova anotaci√≥ al DOM ---
        function addNewRecordToUI(newRecord) {
            // Afegeix la nova anotaci√≥ a la llista de dades local.
            allData.unshift(newRecord);
            
            // Ordena la llista global
            allData.sort((a, b) => parseDate(b.Data) - parseDate(a.Data));
            
            // Actualitzar la pestanya activa amb la nova fila
            if (activeTabId === 'alumne-curs') {
                const selectedAlumne = alumneSelect.value;
                if (newRecord.Alumne === selectedAlumne) {
                    loadStudentInfo(); // Recarregar la taula per mantenir l'ordre
                }
            } else if (activeTabId === 'alumnes') {
                const selectedAlumne = allAlumneSelect.value;
                if (newRecord.Alumne === selectedAlumne) {
                    loadAllStudentRecords(); // Recarregar la taula per mantenir l'ordre
                }
            } else if (activeTabId === 'grups') {
                if (groupMode === 'existing') {
                    const selectedCurs = groupCursSelect.value;
                    const selectedEnsenyament = groupEnsenyamentSelect.value;
                    if (newRecord.Curs === selectedCurs && newRecord.Ensenyament === selectedEnsenyament) {
                        onGroupEnsenyamentChange(); // Recarregar la taula per mantenir l'ordre
                    }
                }
            } else if (activeTabId === 'diari') {
                const selectedCurs = diariCursSelect.value;
                const selectedEnsenyament = diariEnsenyamentSelect.value;
                if (newRecord.Curs === selectedCurs && newRecord.Ensenyament === selectedEnsenyament) {
                    onDiariEnsenyamentChange(); // Recarregar la taula per mantenir l'ordre
                }
            }
        }
        
        // --- Funci√≥ per mostrar/amagar les pestanyes ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        function showTab(tabId) {
            tabButtons.forEach(button => button.classList.remove('active'));
            tabContents.forEach(content => content.classList.add('hidden'));

            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
            const newActiveTab = document.getElementById(`tab-${tabId}`);
            newActiveTab.classList.remove('hidden');

            activeTabId = tabId;

            // Reiniciem les seleccions i dades en canviar de pestanya
            if (tabId === 'alumne-curs') {
                resetAlumneCursTab();
            } else if (tabId === 'alumnes') {
                resetAlumnesTab();
            } else if (tabId === 'grups') {
                resetGrupsTab();
            } else if (tabId === 'diari') {
                resetDiariTab();
            }
        }
        
        // Restableix la pestanya "Alumne d'un curs"
        function resetAlumneCursTab() {
            cursSelect.value = '';
            ensenyamentSelect.value = '';
            alumneSelect.value = '';
            ensenyamentSelect.disabled = true;
            alumneSelect.disabled = true;
            studentInfo.classList.add('hidden');
            populateMainCursos();
        }

        // Restableix la pestanya "Alumnes"
        function resetAlumnesTab() {
            allAlumneSelect.value = '';
            allStudentRecordsContainer.classList.add('hidden');
            populateAllAlumnes();
        }

        // Restableix la pestanya "Grups"
        function resetGrupsTab() {
            groupCursSelect.value = '';
            groupEnsenyamentSelect.value = '';
            groupEnsenyamentSelect.disabled = true;
            groupInfo.classList.add('hidden');
            populateGroupCursos();
            
            // Resetea y oculta la parte de grupo nuevo
            newGroupCursSelect.value = '';
            newGroupEnsenyamentInput.value = '';
            document.querySelector('input[name="groupMode"][value="existing"]').checked = true;
            onGroupModeChange();
        }

        // Restableix la nova pestanya "Diari"
        function resetDiariTab() {
            diariCursSelect.value = '';
            diariEnsenyamentSelect.value = '';
            diariEnsenyamentSelect.disabled = true;
            diariAnotacionsTableContainer.classList.add('hidden');
            populateDiariCursos();
            setTodayDate('diariDataSelect');
        }

        function setTodayDate(id = null) {
            const today = new Date().toISOString().split('T')[0];
            if (id) {
                document.getElementById(id).value = today;
            } else {
                document.getElementById('newRecordDate_alumneCurs').value = today;
                document.getElementById('newRecordDate_alumnes').value = today;
                document.getElementById('newRecordDate_grups').value = today;
            }
        }

        // Netejar els camps del formulari actiu
        function clearActiveForm() {
            if (activeTabId === 'alumne-curs') {
                document.getElementById('newRecordNote_alumneCurs').value = '';
                document.getElementById('newRecordType_alumneCurs').value = '';
            } else if (activeTabId === 'alumnes') {
                document.getElementById('formCurs_alumnes').value = '';
                document.getElementById('newCurs_alumnes').value = '';
                document.getElementById('formEnsenyament_alumnes').value = '';
                document.getElementById('newEnsenyament_alumnes').value = '';
                document.getElementById('newRecordNote_alumnes').value = '';
                document.getElementById('newRecordType_alumnes').value = '';
            } else if (activeTabId === 'grups') {
                document.getElementById('newAlumne_grups').value = '';
                document.getElementById('formAlumne_grups').value = '';
                document.getElementById('newRecordNote_grups').value = '';
                document.getElementById('newRecordType_grups').value = '';
            }
            setTodayDate();
        }

        // Configura tots els listeners d'esdeveniments
        function setupEventListeners() {
            // Pestanya "Alumne d'un curs"
            cursSelect.addEventListener('change', onCursChange);
            ensenyamentSelect.addEventListener('change', onEnsenyamentChange);
            alumneSelect.addEventListener('change', loadStudentInfo);
            generateGeminiBtn.addEventListener('click', generateSummaryAndSuggestion);

            // Pestanya "Alumnes"
            allAlumneSelect.addEventListener('change', loadAllStudentRecords);
            newCursAlumnes.addEventListener('input', () => populateFormEnsenyaments('alumnes'));
            formCursAlumnes.addEventListener('change', () => populateFormEnsenyaments('alumnes'));
            newEnsenyamentAlumnes.addEventListener('input', () => { /* No cal fer res, la selecci√≥ es fa al guardar */ });
            formEnsenyamentAlumnes.addEventListener('change', () => { /* No cal fer res */ });

            // Pestanya "Grups"
            document.querySelectorAll('input[name="groupMode"]').forEach(radio => {
                radio.addEventListener('change', onGroupModeChange);
            });
            groupCursSelect.addEventListener('change', onGroupCursChange);
            groupEnsenyamentSelect.addEventListener('change', onGroupEnsenyamentChange);
            
            // Listener para el nuevo formulario de grupo
            newGroupCursSelect.addEventListener('change', () => {
                // Al cambiar el curso, actualizamos el formulario para nuevos grupos
                const selectedCurs = newGroupCursSelect.value;
                const newEnsenyament = newGroupEnsenyamentInput.value.trim();
                setFormGrupsFields(selectedCurs, newEnsenyament);
            });
            newGroupEnsenyamentInput.addEventListener('input', () => {
                const selectedCurs = newGroupCursSelect.value;
                const newEnsenyament = newGroupEnsenyamentInput.value.trim();
                setFormGrupsFields(selectedCurs, newEnsenyament);
            });
            
            const formAlumneGrups = document.getElementById('formAlumne_grups');
            if (formAlumneGrups) {
                formAlumneGrups.addEventListener('change', () => { document.getElementById('newAlumne_grups').value = '' });
            }
            const newAlumneGrups = document.getElementById('newAlumne_grups');
            if (newAlumneGrups) {
                newAlumneGrups.addEventListener('input', () => { 
                    const formAlumneGrups = document.getElementById('formAlumne_grups');
                    if(formAlumneGrups) formAlumneGrups.value = '';
                });
            }
            
            // Nova pestanya "Diari"
            diariCursSelect.addEventListener('change', onDiariCursChange);
            diariEnsenyamentSelect.addEventListener('change', onDiariEnsenyamentChange);
            document.getElementById('diariSubmitBtn').addEventListener('click', showConfirmation);
            document.getElementById('addAlumneBtn').addEventListener('click', addNewDiariAlumneRow);
            document.getElementById('addDuplicateAlumneBtn').addEventListener('click', addDuplicateAlumneRow);


            // Botons d'afegir anotaci√≥
            document.querySelectorAll('.add-record-btn').forEach(btn => btn.addEventListener('click', showConfirmation));
            document.getElementById('confirmAddBtn').addEventListener('click', confirmAddRecord);
            document.getElementById('cancelAddBtn').addEventListener('click', hideConfirmation);
        }

        // --- Funcions auxiliars per a dates i confirmaci√≥ ---
        function getTipoClass(tipo) {
            if (!tipo) return 'default';
            const cleanedTipo = tipo.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s/g, '');
            return `tipo-${cleanedTipo}`;
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return new Date(0);
            // Si la data ja est√† en format YYYY-MM-DD o ISO, la tractem com a tal
            if (dateStr.includes('-')) {
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? new Date(0) : date;
            }
            // Si la data est√† en format DD/MM/YYYY
            if (dateStr.includes('/')) {
                const [day, month, year] = dateStr.split('/');
                return new Date(`${year}-${month}-${day}`);
            }
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? new Date(0) : date;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                return dateStr;
            }
            return date.toLocaleDateString('ca-ES');
        }
        
        function getActiveFormValues() {
            let records = [];
            let formId;
            let curs, ensenyament, alumne, date, type, note;

            if (activeTabId === 'diari') {
                const curs = diariCursSelect.value;
                const ensenyament = diariEnsenyamentSelect.value;
                const date = diariDataSelect.value;
                
                const tableRows = document.querySelectorAll('#diariClassTableBody tr');
                tableRows.forEach(row => {
                    const alumneInput = row.querySelector('.diari-alumne-input');
                    let currentAlumne, currentType, currentNote;

                    if (alumneInput) { // Fila de nou alumne
                        currentAlumne = alumneInput.value.trim();
                        currentType = row.querySelector('.diari-tipo-select').value;
                        currentNote = row.querySelector('.diari-anotacio-textarea').value.trim();
                        
                        if (currentAlumne && currentType && currentNote) {
                             records.push({ curs, ensenyament, alumne: currentAlumne, date, type: currentType, note: currentNote });
                        }
                    } else { // Fila d'alumne existent (original o duplicada)
                        currentAlumne = row.dataset.alumne;
                        currentType = row.querySelector('.diari-tipo-select').value;
                        currentNote = row.querySelector('.diari-anotacio-textarea').value.trim();

                        if (currentNote) { // Nom√©s afegim les anotacions que tinguin text
                            records.push({ curs, ensenyament, alumne: currentAlumne, date, type: currentType, note: currentNote });
                        }
                    }
                });

                return { records };
                
            } else {
                if (activeTabId === 'alumne-curs') {
                    formId = 'alumneCurs';
                    curs = document.getElementById(`formCurs_${formId}`).value;
                    ensenyament = document.getElementById(`formEnsenyament_${formId}`).value;
                    alumne = document.getElementById(`formAlumne_${formId}`).value;
                    date = document.getElementById(`newRecordDate_${formId}`).value;
                    type = document.getElementById(`newRecordType_${formId}`).value;
                    note = document.getElementById(`newRecordNote_${formId}`).value;
                } else if (activeTabId === 'alumnes') {
                    formId = 'alumnes';
                    const selectedCurs = document.getElementById(`newCurs_${formId}`).value.trim() || document.getElementById(`formCurs_${formId}`).value;
                    const selectedEnsenyament = document.getElementById(`newEnsenyament_${formId}`).value.trim() || document.getElementById(`formEnsenyament_${formId}`).value;
                    curs = selectedCurs;
                    ensenyament = selectedEnsenyament;
                    alumne = document.getElementById(`formAlumne_${formId}`).value;
                    date = document.getElementById(`newRecordDate_${formId}`).value;
                    type = document.getElementById(`newRecordType_${formId}`).value;
                    note = document.getElementById(`newRecordNote_${formId}`).value;
                } else if (activeTabId === 'grups') {
                    formId = 'grups';
                    if (groupMode === 'existing') {
                        curs = document.getElementById('formCurs_grups').value;
                        ensenyament = document.getElementById('formEnsenyament_grups').value;
                    } else { // 'new' mode
                        curs = document.getElementById('newGroupCursSelect').value;
                        ensenyament = document.getElementById('newGroupEnsenyamentInput').value.trim();
                    }
                    const selectedAlumne = document.getElementById(`newAlumne_${formId}`).value.trim() || document.getElementById(`formAlumne_${formId}`).value;
                    alumne = selectedAlumne;
                    date = document.getElementById(`newRecordDate_${formId}`).value;
                    type = document.getElementById(`newRecordType_${formId}`).value;
                    note = document.getElementById(`newRecordNote_${formId}`).value;
                }

                records.push({ curs, ensenyament, alumne, date, type, note });
                return { records };
            }
        }

        function showConfirmation() {
            clearMessages();
            const { records } = getActiveFormValues();
            
            if (activeTabId === 'diari') {
                if (records.length === 0) {
                    showError('No s\'ha trobat cap anotaci√≥ per afegir. Si us plau, omple almenys una anotaci√≥.');
                    return;
                }
            } else { // Pesta√±es individuales
                const record = records[0];
                if (!record.curs || !record.ensenyament || !record.alumne || !record.date || !record.type || !record.note.trim()) {
                    showError('Si us plau, omple tots els camps obligatoris.');
                    return;
                }
            }
            
            let confirmationHTML = '';
            records.forEach(record => {
                const tipoClass = getTipoClass(record.type);
                confirmationHTML += `
                    <div style="border-bottom: 1px solid #e1e5e9; padding: 10px 0; margin-bottom: 10px;">
                        <p><strong>Alumne:</strong> ${record.alumne}</p>
                        <p><strong>Curs:</strong> ${record.curs}</p>
                        <p><strong>Ensenyament:</strong> ${record.ensenyament}</p>
                        <p><strong>Data:</strong> ${formatDate(record.date)}</p>
                        <p><strong>Tipus:</strong> <span class="tipo-badge ${tipoClass}">${record.type}</span></p>
                        <p><strong>Anotaci√≥:</strong> ${record.note}</p>
                    </div>
                `;
            });
            
            document.getElementById('confirmationDetails').innerHTML = confirmationHTML;
            document.getElementById('confirmationModal').classList.remove('hidden');
        }

        async function confirmAddRecord() {
            hideConfirmation();
            const { records } = getActiveFormValues();
            
            showLoading(`Enviant ${records.length} anotacions al servidor...`);
            clearMessages();

            let allSuccessful = true;
            const newRecordsAddedToUI = [];
            
            for (const record of records) {
                const formattedDate = formatDate(record.date);
                
                // Pas 1: Actualitzem la UI localment de forma instant√†nia
                const newRecord = {
                    Curs: record.curs,
                    Ensenyament: record.ensenyament,
                    Alumne: record.alumne,
                    Data: formattedDate,
                    Tipus: record.type,
                    Anotaci√≥: record.note
                };
                addNewRecordToUI(newRecord);
                newRecordsAddedToUI.push(newRecord);
                
                const params = new URLSearchParams();
                params.append('action', 'write');
                params.append('sheetId', SHEET_ID);
                params.append('sheetName', FULL);
                params.append('curs', record.curs);
                params.append('ensenyament', record.ensenyament);
                params.append('alumne', record.alumne);
                params.append('data', formattedDate);
                params.append('tipus', record.type);
                params.append('anotacio', record.note);

                const url = `${SCRIPT_URL}?${params.toString()}`;

                try {
                    const result = await makeJSONPRequest(url);
                    if (!result.success) {
                        allSuccessful = false;
                        console.error('Error en guardar anotaci√≥ per a', record.alumne, ':', result.message);
                    }
                } catch (error) {
                    allSuccessful = false;
                    console.error('Error de connexi√≥ per a', record.alumne, ':', error);
                }
            }
            
            hideLoading();
            if (allSuccessful) {
                showSuccess(`S'han afegit i desat correctament ${records.length} anotacions al servidor!`);
                clearDiariForm();
            } else {
                showError('S\'han afegit les anotacions a la p√†gina, per√≤ hi ha hagut errors en guardar-les al servidor. Si us plau, revisa la consola per a m√©s detalls.');
            }
        }
        
        function clearDiariForm() {
            if (activeTabId === 'diari') {
                const textareas = document.querySelectorAll('.diari-anotacio-textarea');
                const selects = document.querySelectorAll('.diari-tipo-select');
                textareas.forEach(ta => ta.value = '');
                selects.forEach(sel => sel.value = '');
                
                // Netejar les files de nous alumnes
                document.querySelectorAll('.new-alumne-row').forEach(row => row.remove());
                
                setTodayDate('diariDataSelect');
                duplicateAlumneSelect.value = "";
            } else {
                 clearActiveForm();
            }
        }


        function hideConfirmation() {
            document.getElementById('confirmationModal').classList.add('hidden');
        }
        
        function hideGeminiOutput() {
            document.getElementById('geminiOutputModal').classList.add('hidden');
        }

        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function clearMessages() {
            document.getElementById('messageContainer').innerHTML = '';
        }

        function showError(message) {
            clearMessages();
            const errorElement = document.createElement('div');
            errorElement.className = 'message error';
            errorElement.innerHTML = `<strong class="font-bold">Error!</strong> <span class="ml-2">${message}</span>`;
            document.getElementById('messageContainer').appendChild(errorElement);
        }

        function showSuccess(message) {
            clearMessages();
            const successElement = document.createElement('div');
            successElement.className = 'message success';
            successElement.innerHTML = `<strong class="font-bold">√àxit!</strong> <span class="ml-2">${message}</span>`;
            document.getElementById('messageContainer').appendChild(successElement);
        }
        
        // --- Funci√≥ per generar el resum i suggeriment amb Gemini API ---
        async function generateSummaryAndSuggestion() {
            const selectedAlumne = alumneSelect.value;
            if (!selectedAlumne) return;

            const studentRecords = allData.filter(row => 
                row.Curs === cursSelect.value &&
                row.Ensenyament === ensenyamentSelect.value &&
                row.Alumne === selectedAlumne
            );

            if (studentRecords.length === 0) {
                showError('No hi ha anotacions per a aquest alumne per generar un resum.');
                return;
            }

            const notesList = studentRecords.map(record => 
                `Data: ${formatDate(record.Data)}, Tipus: ${record.Tipus}, Anotaci√≥: ${record.Anotaci√≥}`
            ).join('\n\n');

            const prompt = `Act√∫a como tutor en una escuela para adultos. Los alumnos son mayores de edad y a menudo enfrentan situaciones de desventaja socioecon√≥mica o educativa. Basado en las siguientes anotaciones para un alumno llamado ${selectedAlumne}, proporciona un resumen breve y emp√°tico de su progreso o desaf√≠os. A continuaci√≥n, ofrece una sugerencia de acci√≥n de seguimiento que sea constructiva, sensible y orientada al apoyo, como una recomendaci√≥n de una conversaci√≥n con el alumno o una derivaci√≥n a un servicio de apoyo espec√≠fico.

Anotaciones:
${notesList}

Formato de la respuesta:
Resumen: [El resumen aqu√≠]
Sugerencia de acci√≥n: [La sugerencia aqu√≠]`;

            try {
                showLoading('Generando resumen y sugerencia con IA...');

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                
                // IMPORTANT: Insereix aqu√≠ la teva pr√≤pia clau d'API de Gemini per utilitzar l'aplicaci√≥ fora de Canvas.
                // Pots obtenir una clau a https://aistudio.google.com/app/apikey
                const apiKey = "" 

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    let errorDetails = '';
                    try {
                        const errorJson = await response.json();
                        errorDetails = JSON.stringify(errorJson, null, 2);
                    } catch (e) {
                        errorDetails = await response.text();
                    }
                    throw new Error(`Error de l'API: ${response.status} ${response.statusText}. Detalls: ${errorDetails}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    showGeminiOutput(text);
                    showSuccess('Resum i suggeriment generats correctament!');
                } else {
                    throw new Error("Resposta inesperada de l'API de Gemini.");
                }

            } catch (error) {
                console.error('Error al generar el resum amb Gemini:', error);
                showError('No s\'ha pogut generar el resum. Per favor, verifica la teva clau d\'API i torna a intentar-ho m√©s tard.');
            } finally {
                hideLoading();
            }
        }
        
        function showGeminiOutput(text) {
            document.getElementById('geminiOutputTitle').textContent = `Resum i Suggeriment per a ${alumneSelect.value}`;
            document.getElementById('geminiOutputContent').textContent = text;
            document.getElementById('geminiOutputModal').classList.remove('hidden');
        }
    </script>
</body>
</html>
