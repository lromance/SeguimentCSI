<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2Gestió d'Anotacions d'Alumnes</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-4xl font-bold text-center text-blue-800 mb-8">Gestió d'Anotacions d'Alumnes</h1>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="flex justify-center items-center h-40">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
            <span class="ml-4 text-blue-500 font-semibold text-lg">Carregant dades...</span>
        </div>

        <!-- Main Dashboard Screen -->
        <div id="dashboard" class="hidden transition-all duration-300">
            <!-- Filter Section and Add Button -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
                <div class="flex-grow flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 w-full">
                    <div class="w-full">
                        <label for="course-select" class="block text-sm font-medium text-gray-700">Curs</label>
                        <select id="course-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 bg-gray-50"></select>
                    </div>
                    <div class="w-full">
                        <label for="subject-select" class="block text-sm font-medium text-gray-700">Ensenyament</label>
                        <select id="subject-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 bg-gray-50"></select>
                    </div>
                    <div class="w-full">
                        <label for="student-select" class="block text-sm font-medium text-gray-700">Alumne</label>
                        <select id="student-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 bg-gray-50"></select>
                    </div>
                </div>
                <button id="add-note-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-green-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 w-full md:w-auto">
                    Afegir nova anotació
                </button>
            </div>

            <!-- Student Notes Table -->
            <div id="notes-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-center" id="notes-title">Anotacions de l'alumne</h2>
                <div id="notes-table-container" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg">
                        <thead class="bg-blue-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Data</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Tipus d'anotació</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Anotació</th>
                            </tr>
                        </thead>
                        <tbody id="notes-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be inserted here by JavaScript -->
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center">Selecciona un alumne per veure les seves anotacions.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Modal Base Structure (hidden by default) -->
    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center p-4 z-50 hidden transition-opacity duration-300">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl transform scale-95 transition-transform duration-300">
            <!-- Modal content will be inserted here dynamically -->
        </div>
    </div>

    <script>
        // DOM elements references
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboard = document.getElementById('dashboard');

        const courseSelect = document.getElementById('course-select');
        const subjectSelect = document.getElementById('subject-select');
        const studentSelect = document.getElementById('student-select');
        const notesTableBody = document.getElementById('notes-table-body');
        const addNoteBtn = document.getElementById('add-note-btn');

        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');

        // Global state
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYYsAHt_I1v3aGhddU4VNkZXPyGuC587yUykZfiqHpD0_19mWyWFv28Rh1-Fm7jAVq2g/exec';
        const SPREADSHEET_ID = '1a4y6_jE1N60BH5nJDVXgsaMPvM5ocYl-WHVSyl0F48w';

        let allData = [];
        let courses = [];
        let subjects = [];
        let students = [];
        let selectedStudentData = [];
        
        let selectedCourse = '';
        let selectedSubject = '';
        let selectedStudent = '';

        const noteTypes = ['Acadèmic', 'Social', 'Absentisme', 'Comportament', 'Altres'];

        // --- Helper functions ---
        
        /**
         * Fetches data from the Google Apps Script.
         * @param {string} url The script URL.
         * @param {string} method The HTTP method ('GET' or 'POST').
         * @param {object} [data=null] The data to send with a POST request.
         * @returns {Promise<object>} The JSON response.
         */
        async function fetchData(url, method, data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        }

        /**
         * Renders a custom modal with a given title, message, and buttons.
         * @param {string} title The modal title.
         * @param {string} message The modal body content (HTML string).
         * @param {Array<object>} buttons Array of button objects { text, className, handler }.
         */
        function renderModal(title, message, buttons) {
            let buttonsHtml = buttons.map(btn => 
                `<button class="py-2 px-4 rounded-full font-semibold transition-all duration-200 ${btn.className}" onclick="${btn.handler}">${btn.text}</button>`
            ).join('');

            modalContent.innerHTML = `
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold">${title}</h3>
                    <button class="text-gray-500 hover:text-gray-800" onclick="hideModal()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-gray-700 mb-6">${message}</div>
                <div class="flex justify-end space-x-4">${buttonsHtml}</div>
            `;
            modalContainer.classList.remove('hidden');
        }

        /** Hides the currently visible modal. */
        function hideModal() {
            modalContainer.classList.add('hidden');
            modalContent.innerHTML = '';
        }

        /** Shows an error modal. */
        function showErrorModal(message) {
            renderModal(
                'Error',
                `<p class="text-red-600">${message}</p>`,
                [{ text: 'Tanca', className: 'bg-gray-200 text-gray-800 hover:bg-gray-300', handler: 'hideModal()' }]
            );
        }

        // --- Core Application Logic ---

        /** Loads all data from Google Sheets and initializes the app. */
        async function loadData() {
            loadingIndicator.classList.remove('hidden');
            dashboard.classList.add('hidden');

            try {
                const getUrl = `${SCRIPT_URL}?spreadsheetId=${SPREADSHEET_ID}`;
                const response = await fetchData(getUrl, 'GET');
                
                if (response.status === 'success' && response.data) {
                    allData = response.data;
                    console.log('Data loaded:', allData);

                    // Extract unique courses and populate the dropdown
                    courses = [...new Set(allData.map(item => item.Curs))].sort();
                    populateDropdown(courseSelect, courses, 'Selecciona un curs...');
                    
                    dashboard.classList.remove('hidden');
                } else {
                    showErrorModal(`Error al carregar les dades: ${response.message || 'Resposta inesperada.'}`);
                }
            } catch (error) {
                showErrorModal(`Ha fallat la connexió: ${error.message}`);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        /** Populates a dropdown with a given array of values. */
        function populateDropdown(dropdown, values, placeholder) {
            dropdown.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                dropdown.appendChild(option);
            });
            dropdown.disabled = values.length === 0;
        }

        /** Updates the subjects dropdown based on the selected course. */
        function updateSubjects() {
            selectedCourse = courseSelect.value;
            subjectSelect.value = '';
            studentSelect.value = '';
            notesTableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center">Selecciona un alumne per veure les seves anotacions.</td></tr>';
            
            if (selectedCourse) {
                const filteredSubjects = [...new Set(allData
                    .filter(item => item.Curs === selectedCourse)
                    .map(item => item.Ensenyament))].sort();
                populateDropdown(subjectSelect, filteredSubjects, 'Selecciona un ensenyament...');
            } else {
                populateDropdown(subjectSelect, [], 'Selecciona un ensenyament...');
            }
            populateDropdown(studentSelect, [], 'Selecciona un alumne...');
        }

        /** Updates the students dropdown based on the selected course and subject. */
        function updateStudents() {
            selectedSubject = subjectSelect.value;
            studentSelect.value = '';
            notesTableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center">Selecciona un alumne per veure les seves anotacions.</td></tr>';

            if (selectedCourse && selectedSubject) {
                const filteredStudents = [...new Set(allData
                    .filter(item => item.Curs === selectedCourse && item.Ensenyament === selectedSubject)
                    .map(item => item.Alumne))].sort();
                populateDropdown(studentSelect, filteredStudents, 'Selecciona un alumne...');
            } else {
                populateDropdown(studentSelect, [], 'Selecciona un alumne...');
            }
        }

        /** Renders the notes table for the selected student. */
        function renderStudentNotes() {
            selectedStudent = studentSelect.value;
            
            if (selectedStudent) {
                selectedStudentData = allData.filter(item =>
                    item.Curs === selectedCourse &&
                    item.Ensenyament === selectedSubject &&
                    item.Alumne === selectedStudent
                );

                // Sort notes by date in descending order
                selectedStudentData.sort((a, b) => new Date(b.Data) - new Date(a.Data));
                
                let notesHtml = '';
                if (selectedStudentData.length > 0) {
                    notesHtml = selectedStudentData.map((note, index) => `
                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${note.Data}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${note["Tipus d'anotació"]}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${note.Anotació}</td>
                        </tr>
                    `).join('');
                } else {
                    notesHtml = `<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center">Aquest alumne no té anotacions.</td></tr>`;
                }

                notesTableBody.innerHTML = notesHtml;
            } else {
                notesTableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 text-center">Selecciona un alumne per veure les seves anotacions.</td></tr>';
            }
        }

        /** Shows the "add new note" form modal. */
        function showAddNoteModal() {
            if (!selectedStudent) {
                showErrorModal('Si us plau, selecciona un alumne per afegir una nova anotació.');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const noteTypesOptions = noteTypes.map(type => 
                `<option value="${type}">${type}</option>`
            ).join('');

            modalContent.innerHTML = `
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold">Afegir nova anotació</h3>
                    <button class="text-gray-500 hover:text-gray-800" onclick="hideModal()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="add-note-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Curs</label>
                            <input type="text" value="${selectedCourse}" readonly class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm p-3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ensenyament</label>
                            <input type="text" value="${selectedSubject}" readonly class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm p-3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Alumne</label>
                            <input type="text" value="${selectedStudent}" readonly class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm p-3">
                        </div>
                        <div>
                            <label for="note-date" class="block text-sm font-medium text-gray-700">Data</label>
                            <input type="date" id="note-date" value="${today}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3">
                        </div>
                        <div>
                            <label for="note-type" class="block text-sm font-medium text-gray-700">Tipus d'anotació</label>
                            <select id="note-type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3">
                                <option value="" disabled selected>Selecciona un tipus</option>
                                ${noteTypesOptions}
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="note-text" class="block text-sm font-medium text-gray-700">Anotació</label>
                        <textarea id="note-text" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="hideModal()" class="bg-gray-200 text-gray-800 hover:bg-gray-300 py-2 px-4 rounded-full font-semibold transition-colors duration-200">Cancel·la</button>
                        <button type="submit" class="bg-blue-600 text-white hover:bg-blue-700 py-2 px-4 rounded-full font-semibold transition-colors duration-200">Revisa i envia</button>
                    </div>
                </form>
            `;
            modalContainer.classList.remove('hidden');
            
            // Add a submit event listener to the form to handle confirmation
            document.getElementById('add-note-form').addEventListener('submit', function(e) {
                e.preventDefault();
                showConfirmSubmitModal();
            });
        }

        /** Shows a confirmation modal before submitting a new note. */
        function showConfirmSubmitModal() {
            const formData = {
                Curs: selectedCourse,
                Ensenyament: selectedSubject,
                Alumne: selectedStudent,
                Data: document.getElementById('note-date').value,
                "Tipus d'anotació": document.getElementById('note-type').value,
                Anotació: document.getElementById('note-text').value,
            };

            const confirmMessage = `
                <p>Estàs segur que vols afegir aquesta anotació?</p>
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <p><strong>Curs:</strong> ${formData.Curs}</p>
                    <p><strong>Ensenyament:</strong> ${formData.Ensenyament}</p>
                    <p><strong>Alumne:</strong> ${formData.Alumne}</p>
                    <p><strong>Data:</strong> ${formData.Data}</p>
                    <p><strong>Tipus:</strong> ${formData["Tipus d'anotació"]}</p>
                    <p><strong>Anotació:</strong> ${formData.Anotació}</p>
                </div>
            `;
            
            renderModal(
                'Confirmar anotació',
                confirmMessage,
                [
                    { text: 'Cancel·la', className: 'bg-gray-200 text-gray-800 hover:bg-gray-300', handler: 'showAddNoteModal()' },
                    { text: 'Confirma i Envia', className: 'bg-green-600 text-white hover:bg-green-700', handler: 'submitNewNote()' }
                ]
            );
        }

        /** Submits the new note to the Google Apps Script. */
        async function submitNewNote() {
            hideModal(); // Hide the confirmation modal
            loadingIndicator.classList.remove('hidden');

            const formData = {
                action: 'addNote',
                spreadsheetId: SPREADSHEET_ID,
                Curs: selectedCourse,
                Ensenyament: selectedSubject,
                Alumne: selectedStudent,
                Data: document.getElementById('note-date').value,
                "Tipus d'anotació": document.getElementById('note-type').value,
                Anotació: document.getElementById('note-text').value,
            };

            try {
                const response = await fetchData(SCRIPT_URL, 'POST', formData);

                if (response.status === 'success') {
                    renderModal(
                        'Anotació afegida',
                        `<p class="text-green-600">L'anotació s'ha afegit correctament.</p>`,
                        [{ text: 'Tanca', className: 'bg-gray-200 text-gray-800 hover:bg-gray-300', handler: 'hideModal()' }]
                    );
                    // Refresh the data and the table
                    await loadData();
                    renderStudentNotes();
                } else {
                    showErrorModal(`Error a l'afegir l'anotació: ${response.message || 'Resposta inesperada.'}`);
                }
            } catch (error) {
                showErrorModal(`Ha fallat l'enviament: ${error.message}`);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        window.addEventListener('load', loadData);
        courseSelect.addEventListener('change', updateSubjects);
        subjectSelect.addEventListener('change', updateStudents);
        studentSelect.addEventListener('change', renderStudentNotes);
        addNoteBtn.addEventListener('click', showAddNoteModal);
    </script>

</body>
</html>
